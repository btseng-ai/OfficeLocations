<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LJA Office Locations</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { height: 800px; width: 100%; }

    .leaflet-popup-content {
    font-family: Segoe UI, Arial, sans-serif;
    font-size: 13px;
    line-height: 1.4;
  }

  </style>
</head>

<body>
  <div id="map"></div>

  <script>
  // Create the map centered on the U.S.
  var map = L.map('map').setView([37.8, -96], 4);

    // Base (clean, white)
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19,
    attribution: 'Tiles &copy; Esri'
  }).addTo(map);


  // --- Simple CSV parser that supports quoted commas ---
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let field = '';
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (c === '"' && inQuotes && next === '"') {
        field += '"';
        i++;
      } else if (c === '"') {
        inQuotes = !inQuotes;
      } else if (c === ',' && !inQuotes) {
        row.push(field);
        field = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (c === '\r' && next === '\n') i++;
        row.push(field);
        field = '';
        if (row.length > 1 || row[0] !== '') rows.push(row);
        row = [];
      } else {
        field += c;
      }
    }

    // last field
    if (field.length || row.length) {
      row.push(field);
      rows.push(row);
    }
    return rows;
  }

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // IMPORTANT: use relative path since locations.csv is in the same GitHub repo folder
  fetch('https://btseng-ai.github.io/OfficeLocations/locations.csv')
    .then(res => {
      if (!res.ok) throw new Error('Failed to load locations.csv: ' + res.status);
      return res.text();
    })
    .then(csvText => {
      const table = parseCSV(csvText);
      const headers = table[0].map(h => h.trim());
      const dataRows = table.slice(1);

      const idx = (name) => headers.indexOf(name);
      const iLocation = idx('Location');
      const iOffice = idx('Office');
      const iAddr1  = idx('Address Line 1');
      const iAddr2  = idx('Address Line 2');
      const iCity  = idx('City');
      const iState  = idx('State');
      const iZipcode  = idx('Zipcode');
      const iLat    = idx('Lat');
      const iLng    = idx('Lng');
      const iUrl    = idx('FloorplanURL');

      if ([iOffice,iAddr1,iCity,iState,iZipcode,iLat,iLng,iUrl].some(i => i === -1)) {
        throw new Error('CSV headers do not match expected names. Found: ' + headers.join(' | '));
      }

      const bounds = [];

      dataRows.forEach((r) => {
        if (!r || r.length === 0) return;
        const location = r[iLocation]?.trim();
        const office = r[iOffice]?.trim();
        const addr1  = r[iAddr1]?.trim();
        const addr2  = r[iAddr2]?.trim();
        const city   = r[iCity]?.trim();
        const state  = r[iState]?.trim();
        const zipcode= r[iZipcode]?.trim();
        const lat    = parseFloat(r[iLat]);
        const lng    = parseFloat(r[iLng]);
        const url    = r[iUrl]?.trim();

        // skip bad rows
        if (!office || Number.isNaN(lat) || Number.isNaN(lng)) return;
        const fullAddress = [addr1, addr2, city, state, zipcode].filter(Boolean).join(', ');
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;
        
        const popup = `
          <b>${escapeHtml(office)} - ${escapeHtml(location)}</b><br>
          <a href="${mapsUrl}" target="_blank" rel="noopener">
            ${escapeHtml(addr1)}<br>
            ${addr2 ? `${escapeHtml(addr2)}<br>` : ''}
            ${escapeHtml(city)}, ${escapeHtml(state)} ${escapeHtml(zipcode)}
          </a><br><br>
          ${url ? `<a target="_blank" rel="noopener" href="${escapeHtml(url)}">Floor Plan</a>` : ''}
        `;

        L.marker([lat, lng]).addTo(map).bindPopup(popup);
        bounds.push([lat, lng]);
      });

      // Zoom to fit all markers (if at least one)
      if (bounds.length) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    })
    .catch(err => {
      console.error(err);
      alert('Map data load failed. Open DevTools console for details.');
    });
</script>
</body>
</html>
